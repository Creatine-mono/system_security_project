import { NextRequest, NextResponse } from 'next/server';
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { cveId, rawData } = body;

    if (!cveId && !rawData) {
      return NextResponse.json(
        { error: 'CVE ID or raw data is required' },
        { status: 400 }
      );
    }

    // Fetch CVE data if only ID is provided
    let vulnerabilityData = rawData;
    if (!vulnerabilityData && cveId) {
      const response = await fetch(`http://localhost:8000/api/cve/${cveId}`);
      if (!response.ok) {
        throw new Error('Failed to fetch CVE data');
      }
      const data = await response.json();
      vulnerabilityData = data.result;
    }

    // Create AI analysis prompt
    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2048,
      messages: [
        {
          role: 'user',
          content: `ë‹¤ìŒì€ ë³´ì•ˆ ì·¨ì•½ì  ì •ë³´ì…ë‹ˆë‹¤. ë³´ì•ˆ ì „ë¬¸ê°€ ê´€ì ì—ì„œ ìƒì„¸í•˜ê³  ì •í™•í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì·¨ì•½ì  ë°ì´í„°:
${vulnerabilityData}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

## ğŸ“‹ ì·¨ì•½ì  ìš”ì•½
(ì·¨ì•½ì ì˜ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ì‰½ê²Œ ì„¤ëª…)

## âš ï¸ ì‹¤ì œ ìœ„í—˜ë„ í‰ê°€
(CVSS ì ìˆ˜ í•´ì„, ì‹¤ì œ ê³µê²© ê°€ëŠ¥ì„±, ì•…ìš© ë‚œì´ë„ ë“±)

## ğŸ¯ ì˜í–¥ë°›ëŠ” ì‹œìŠ¤í…œ
(ì–´ë–¤ ì‹œìŠ¤í…œ/ì†Œí”„íŠ¸ì›¨ì–´ê°€ ì˜í–¥ì„ ë°›ëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ)

## ğŸš¨ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­
(ì§€ê¸ˆ ë‹¹ì¥ í•´ì•¼ í•  ê¸´ê¸‰ ì¡°ì¹˜ 3-5ê°€ì§€ë¥¼ ë²ˆí˜¸ë¡œ ë‚˜ì—´)

## ğŸ›¡ï¸ ì¥ê¸° ëŒ€ì‘ ë°©ì•ˆ
(ê·¼ë³¸ì ì¸ í•´ê²°ì±…ê³¼ ì˜ˆë°© ì¡°ì¹˜)

## ğŸ’¡ ì°¸ê³ ì‚¬í•­
(ì¶”ê°€ë¡œ ì•Œì•„ì•¼ í•  ì¤‘ìš”í•œ ì •ë³´)

**ì¤‘ìš”**:
- ì‚¬ì‹¤ì— ê¸°ë°˜í•˜ì—¬ ì •í™•í•˜ê²Œ ë¶„ì„í•˜ì„¸ìš”
- ê³¼ì¥í•˜ì§€ ë§ê³  ë³´ìˆ˜ì ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”
- í•œê¸€ë¡œ ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•˜ì„¸ìš”
- ê¸°ìˆ  ìš©ì–´ëŠ” í•„ìš”ì‹œ ê°„ë‹¨íˆ ì„¤ëª…ì„ ì¶”ê°€í•˜ì„¸ìš”`,
        },
      ],
    });

    const analysis = message.content[0].type === 'text' ? message.content[0].text : '';

    return NextResponse.json({
      success: true,
      analysis,
      model: 'claude-sonnet-4-20250514',
      timestamp: new Date().toISOString(),
    });
  } catch (error: any) {
    console.error('AI Analysis Error:', error);
    return NextResponse.json(
      { error: error.message || 'Failed to analyze vulnerability' },
      { status: 500 }
    );
  }
}
