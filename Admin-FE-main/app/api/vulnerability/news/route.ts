import { NextResponse } from 'next/server';

// Match standard CVE IDs like CVE-2024-1234 (4+ digits after the year)
const CVE_REGEX = /\bCVE-\d{4}-\d{4,}\b/gi;
const CIRCL_URL = 'https://cve.circl.lu/api/last';

function extractCveAndSummary(item: any) {
  // Try to find a CVE anywhere in the object
  const text = JSON.stringify(item);
  const match = text.match(CVE_REGEX);
  const cve = match ? match[0].toUpperCase() : '';

  const summary =
    item.summary ||
    item.title ||
    item.document?.title ||
    item.document?.notes?.[0]?.text ||
    'No summary available.';

  const published =
    item.Published ||
    item.published ||
    item.document?.tracking?.current_release_date ||
    item.document?.tracking?.initial_release_date ||
    '';

  return { cve, summary, published };
}

export async function GET() {
  try {
    // bypass SSL issues for circl if needed
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';

    let items: any[] = [];

    try {
      const res = await fetch(CIRCL_URL, { cache: 'no-store' });
      if (res.ok) {
        const data = await res.json();
        if (Array.isArray(data)) {
          items = data
            .slice(0, 300) // avoid huge payload
            .map(extractCveAndSummary)
            .filter((x) => x.cve);
        }
      }
    } catch (_) {
      // ignore
    }

    const seen = new Set<string>();
    const deduped = [];
    for (const item of items) {
      if (!seen.has(item.cve)) {
        seen.add(item.cve);
        deduped.push(item);
      }
      if (deduped.length >= 300) break;
    }

    deduped.sort((a: any, b: any) => {
      const ta = Date.parse(a.published || '') || 0;
      const tb = Date.parse(b.published || '') || 0;
      return tb - ta;
    });

    return NextResponse.json({ items: deduped.slice(0, 7) });
  } catch (error: any) {
    console.error('News fetch error:', error);
    return NextResponse.json(
      { error: error.message || 'Failed to fetch CVE news' },
      { status: 500 }
    );
  }
}
